{% include 'header.html' %}

<meta name="theme-color" content="#ffffff">

<script async src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root {
  --tg-theme-bg-color: #ffffff;
  --tg-theme-text-color: #000000;
  --tg-theme-hint-color: #999999;
  --tg-theme-link-color: #0088cc;
  --tg-theme-button-color: #0088cc;
  --tg-theme-button-text-color: #ffffff;
  --tg-theme-secondary-bg-color: #f5f5f5;
}

html, body {
  width: 100%;
  height: 100%;
  overflow: hidden;
  overscroll-behavior: none;
  margin: 0;
  padding: 0;
}

body {
  background: var(--tg-theme-bg-color);
  color: var(--tg-theme-text-color);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  -webkit-font-smoothing: antialiased;
  /* ğŸ›‘ á‹ˆáˆ³áŠ áˆ›áˆµá‰°áŠ«áŠ¨á‹«á¡ áŠ¨áˆ˜áŒ áŠ• á‰ áˆ‹á‹­ áˆ˜áˆ¸á‰¥áˆˆáˆáŠ• áŠ áˆµá‹ˆáŒá‹µ */
  overflow-y: hidden;
}

/* ğŸš© á‹ˆáˆ³áŠ áˆ›áˆµá‰°áŠ«áŠ¨á‹«á¡ #root á‹ˆá‹­áˆ App á‹¨áˆšá‰€áˆ˜áŒ¥á‰ á‰µ áˆ˜á‹«á‹£ áˆ™áˆ‰á‹áŠ• á‰¦á‰³ á‹­á‹ˆáˆµá‹³áˆ */
#root {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  /* á‹Œá‰¥ áŠ á‘ á‹áˆµáŒ¥ á‹«áˆˆá‹ á‹­á‹˜á‰µ áŠ¨á‰ á‹› á‰¥á‰» áŠ¥áŠ•á‹²áˆ¸á‰ áˆˆáˆ á‹­áˆá‰…á‹³áˆ */
  overflow-y: auto;
}

.mini-app-container {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  width: 100%;
  height: 100%;
  min-height: 100vh;
  padding: 12px;
  background: linear-gradient(135deg, var(--tg-theme-bg-color), var(--tg-theme-secondary-bg-color));
  box-sizing: border-box;
  overflow-y: auto;
}

.mini-app-content {
  background: var(--tg-theme-bg-color);
  border-radius: 12px;
  padding: 20px 16px;
  text-align: center;
  width: 100%;
  max-width: 320px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  animation: slideUp 0.5s ease-out;
  box-sizing: border-box;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.mini-app-icon {
  font-size: 64px;
  margin-bottom: 16px;
  display: inline-block;
}

.mini-app-title {
  font-size: 28px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--tg-theme-text-color);
}

.mini-app-subtitle {
  font-size: 16px;
  color: var(--tg-theme-hint-color);
  margin-bottom: 28px;
  line-height: 1.4;
}

.mini-app-button {
  background: var(--tg-theme-button-color);
  color: var(--tg-theme-button-text-color);
  border: none;
  border-radius: 8px;
  padding: 12px 24px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
  transition: opacity 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.mini-app-button:active {
  opacity: 0.8;
}

.mini-app-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.mini-app-footer {
  font-size: 12px;
  color: var(--tg-theme-hint-color);
  margin-top: 20px;
}

.loading-spinner {
  display: none;
  width: 16px;
  height: 16px;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-spinner.active {
  display: inline-block;
}
</style>

<div id="root">
  <div class="mini-app-container">
    <div class="mini-app-content">
    <div class="mini-app-icon">ğŸš€</div>
    <h1 class="mini-app-title" id="app-title">á‰  Telegram á‹­áŒá‰¡</h1>
    <p class="mini-app-subtitle" id="app-subtitle">
      G-Task Manager á‹ˆá‹° Telegram Mini App á‰°á‰€á‹­áˆ¯áˆ
    </p>
    
    <button id="login-btn" class="mini-app-button">
      <span class="loading-spinner" id="spinner"></span>
      <span id="btn-text">ğŸ“± á‹ˆá‹­áˆ á‹­áŒ€áˆáˆ©</span>
    </button>
    
    <p class="mini-app-footer" id="app-footer">
      âš ï¸ á‹­áˆ… áŒˆáŒ½ á‰  Telegram á‹áˆµáŒ¥ á‰¥á‰» á‹­áˆ°áˆ«áˆ
    </p>
  </div>
  </div>
</div>

<script>
// Apply Telegram theme colors dynamically
function applyTelegramTheme() {
  if (!window.Telegram?.WebApp) return;
  
  const themeParams = window.Telegram.WebApp.themeParams || {};
  
  // Set CSS variables from Telegram theme
  const root = document.documentElement;
  root.style.setProperty('--tg-theme-bg-color', themeParams.bg_color || '#ffffff');
  root.style.setProperty('--tg-theme-text-color', themeParams.text_color || '#000000');
  root.style.setProperty('--tg-theme-hint-color', themeParams.hint_color || '#999999');
  root.style.setProperty('--tg-theme-link-color', themeParams.link_color || '#0088cc');
  root.style.setProperty('--tg-theme-button-color', themeParams.button_color || '#0088cc');
  root.style.setProperty('--tg-theme-button-text-color', themeParams.button_text_color || '#ffffff');
  root.style.setProperty('--tg-theme-secondary-bg-color', themeParams.secondary_bg_color || '#f5f5f5');
  
  console.log('âœ… Telegram theme applied');
}

// Initialize Telegram Mini App with proper viewport handling
function initializeTelegramMiniApp() {
  if (window.Telegram?.WebApp) {
    const TelegramWebApp = window.Telegram.WebApp;
    
    try {
      // Initialize SDK
      TelegramWebApp.ready();
      
      // Expand to fullscreen - CRITICAL for proper viewport
      TelegramWebApp.expand();
      
      // Apply theme
      applyTelegramTheme();
      
      // Listen for viewport changes
      if (TelegramWebApp.onEvent) {
        TelegramWebApp.onEvent('viewportChanged', function() {
          TelegramWebApp.expand();
          console.log('âœ… Viewport changed - expanded to:', TelegramWebApp.viewportStableHeight);
        });
        
        TelegramWebApp.onEvent('themeChanged', applyTelegramTheme);
      }
      
      // Show back button
      if (TelegramWebApp.BackButton) {
        TelegramWebApp.BackButton.show();
        TelegramWebApp.BackButton.onClick(() => {
          window.history.back();
        });
      }
      
      console.log('âœ… Telegram Mini App initialized');
      console.log('ğŸ“ Viewport Height:', TelegramWebApp.viewportHeight);
      console.log('ğŸ“ Viewport Stable Height:', TelegramWebApp.viewportStableHeight);
      console.log('âœ… Expanded:', TelegramWebApp.isExpanded);
    } catch (error) {
      console.error('âš ï¸ Error initializing Telegram WebApp:', error);
    }
  }
}

// Wait for Telegram WebApp SDK with retry logic
function waitForTelegramWebApp(callback, attempt = 0) {
  if (window.Telegram?.WebApp) {
    callback();
  } else if (attempt < 50) {
    setTimeout(() => waitForTelegramWebApp(callback, attempt + 1), 100);
  } else {
    console.error('âŒ Telegram WebApp SDK not available');
    if (document.getElementById('login-btn')) {
      document.getElementById('login-btn').disabled = true;
      document.getElementById('btn-text').textContent = 'SDK not available';
    }
  }
}

waitForTelegramWebApp(function() {
  initializeTelegramMiniApp();
  
  const TelegramWebApp = window.Telegram.WebApp;
  
  const loginBtn = document.getElementById('login-btn');
  
  loginBtn.onclick = async function() {
    try {
      // Get the signed initData from Telegram
      const initData = TelegramWebApp.initData;
      const userData = TelegramWebApp.initDataUnsafe?.user;
      
      console.log('ğŸ“± Telegram initData present:', !!initData);
      console.log('ğŸ‘¤ Telegram user data:', userData);
      
      if (!initData) {
        console.error('âŒ No initData available');
        alert('Unable to authenticate with Telegram. initData not found.');
        return;
      }
      
      if (!userData || !userData.id) {
        console.error('âŒ No user data available');
        alert('Unable to get user data from Telegram');
        return;
      }
      
      // Show loading state
      loginBtn.disabled = true;
      document.getElementById('spinner').classList.add('active');
      document.getElementById('btn-text').textContent = 'á‰ áˆ˜á‹°á‹ˆáˆ áˆ‹á‹­...';
      
      console.log('âœ… Sending signed initData to backend for validation');
      
      // Send SIGNED initData to backend
      const response = await fetch('/miniapp_login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          initData: initData,
          user: userData
        })
      });
      
      const data = await response.json();
      console.log('âœ… Login response:', data);
      
      if (data.success) {
        console.log('ğŸ‰ Login successful, redirecting to:', data.redirect);
        window.location.href = data.redirect || '/dashboard';
      } else {
        console.error('âŒ Login failed:', data.message);
        alert('Login failed: ' + data.message);
        
        // Reset button
        loginBtn.disabled = false;
        document.getElementById('spinner').classList.remove('active');
        document.getElementById('btn-text').textContent = 'ğŸ“± á‹ˆá‹­áˆ á‹­áŒ€áˆáˆ©';
      }
    } catch (error) {
      console.error('âŒ Login error:', error);
      alert('Login failed: ' + error.message);
      
      // Reset button
      loginBtn.disabled = false;
      document.getElementById('spinner').classList.remove('active');
      document.getElementById('btn-text').textContent = 'ğŸ“± á‹ˆá‹­áˆ á‹­áŒ€áˆáˆ©';
    }
  };
});
</script>

{% include 'footer.html' %}
