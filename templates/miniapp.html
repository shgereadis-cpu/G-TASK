{% include 'header.html' %}

<script async src="https://telegram.org/js/telegram-web-app.js"></script>

<div class="form-container" style="text-align: center; padding-top: 40px;">
    <h2 style="font-size: 2em; margin-bottom: 20px;">
        <i class="fas fa-rocket" style="color: var(--success-color);"></i> ·â† Telegram ·ã≠·åç·â°
    </h2>
    
    <p style="color: var(--text-light); margin-bottom: 30px; font-size: 1.1em;">
        G-Task Manager ·àõ·ãï·ä®·àç ·ãà·ã∞ Telegram Mini App ·â∞·âÄ·ã≠·àØ·àç
    </p>
    
    <div id="telegram-login-button" style="margin: 30px 0;">
        <button id="login-btn" class="btn success" style="font-size: 1.1em; padding: 15px 30px;">
            <i class="fab fa-telegram"></i> ·â† Telegram Mini App ·ã≠·åÄ·àù·à©
        </button>
    </div>
    
    <p style="color: #999; margin-top: 40px; font-size: 0.9em;">
        ‚ö†Ô∏è ·ã≠·àÖ ·åà·åΩ ·â† Telegram ·ãç·àµ·å• ·â•·âª ·ã≠·à∞·à´·àç
    </p>
</div>

<script>
// Wait for Telegram WebApp SDK to be fully available
function waitForTelegramWebApp(callback, attempt = 0) {
    if (window.Telegram?.WebApp) {
        callback();
    } else if (attempt < 50) {
        setTimeout(() => waitForTelegramWebApp(callback, attempt + 1), 100);
    } else {
        console.error('‚ùå Telegram WebApp SDK not available after 5 seconds');
        document.getElementById('login-btn').disabled = true;
        document.getElementById('login-btn').textContent = 'Telegram Mini App SDK not available';
    }
}

waitForTelegramWebApp(function() {
    const TelegramWebApp = window.Telegram.WebApp;
    TelegramWebApp.ready();
    
    const loginBtn = document.getElementById('login-btn');
    
    loginBtn.onclick = function() {
        try {
            // Get the signed initData from Telegram
            const initData = TelegramWebApp.initData;
            const userData = TelegramWebApp.initDataUnsafe?.user;
            
            console.log('üì± Telegram initData:', initData ? 'Present' : 'Missing');
            console.log('üë§ Telegram user data:', userData);
            
            if (!initData) {
                console.error('‚ùå No initData available');
                alert('Unable to authenticate with Telegram. initData not found.');
                return;
            }
            
            if (!userData || !userData.id) {
                console.error('‚ùå No user data available');
                alert('Unable to get user data from Telegram');
                return;
            }
            
            console.log('‚úÖ Sending signed initData to backend for validation');
            
            // Send SIGNED initData to backend (not just user data!)
            fetch('/miniapp_login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    initData: initData,  // IMPORTANT: Send the signed string
                    user: userData       // Also send user data for reference
                })
            })
            .then(response => {
                console.log('üì¶ Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('‚úÖ Login response:', data);
                if (data.success) {
                    console.log('üéâ Login successful, redirecting to:', data.redirect);
                    window.location.href = data.redirect || '/dashboard';
                } else {
                    console.error('‚ùå Login failed:', data.message);
                    alert('Login failed: ' + data.message);
                }
            })
            .catch(error => {
                console.error('‚ùå Login error:', error);
                alert('Login failed: ' + error.message);
            });
        } catch (e) {
            console.error('‚ùå Exception:', e);
            alert('Error: ' + e.message);
        }
    };
});
</script>

{% include 'footer.html' %}
