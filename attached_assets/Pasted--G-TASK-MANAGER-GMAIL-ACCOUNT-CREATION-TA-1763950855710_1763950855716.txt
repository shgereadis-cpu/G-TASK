# ======================================================
# G-TASK MANAGER: GMAIL ACCOUNT CREATION TASK MANAGER
# Version: 3.0 (FINAL BACKEND: PostgreSQL + Ads System)
# Author: Gemini (AI)
# ======================================================

import os
import time
from flask import Flask, render_template, request, session, redirect, url_for, flash, jsonify
from werkzeug.security import generate_password_hash, check_password_hash
from flask_sqlalchemy import SQLAlchemy
from sqlalchemy import func
from dotenv import load_dotenv

# --- 0. ENV SETUP & CONFIGURATION ---
load_dotenv() 
app = Flask(__name__)
app.secret_key = os.urandom(24) 

# Database Configuration (Neon/PostgreSQL)
app.config['SQLALCHEMY_DATABASE_URI'] = os.environ.get('DATABASE_URL')
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False

db = SQLAlchemy(app)

MIN_PAYOUT = 1.00 
PAYOUT_AMOUNT_PER_TASK = 0.10 

# --- 1. DATABASE MODELS (SQLAlchemy Models) ---

class User(db.Model):
    __tablename__ = 'users'
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(80), unique=True, nullable=False)
    password_hash = db.Column(db.String(128), nullable=False)
    is_admin = db.Column(db.Boolean, default=False)
    total_earned = db.Column(db.Float, default=0.0)
    pending_payout = db.Column(db.Float, default=0.0)
    
    tasks = db.relationship('Task', backref='worker', lazy='dynamic')
    payouts = db.relationship('Payout', backref='requester', lazy='dynamic')
    ad_views = db.relationship('AdView', backref='viewer', lazy='dynamic') # NEW

class Inventory(db.Model):
    __tablename__ = 'inventory'
    id = db.Column(db.Integer, primary_key=True)
    gmail_username = db.Column(db.String(120), unique=True, nullable=False)
    gmail_password = db.Column(db.String(120), nullable=False)
    status = db.Column(db.String(20), default='AVAILABLE') 
    date_added = db.Column(db.DateTime, default=func.now())
    
    task = db.relationship('Task', backref='inventory_item', uselist=False)

class Task(db.Model):
    __tablename__ = 'tasks'
    id = db.Column(db.Integer, primary_key=True)
    inventory_id = db.Column(db.Integer, db.ForeignKey('inventory.id'), unique=True, nullable=False)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    completion_code = db.Column(db.String(100))
    status = db.Column(db.String(20), default='PENDING') 
    date_assigned = db.Column(db.DateTime, default=func.now())
    date_completed = db.Column(db.DateTime)

class Payout(db.Model):
    __tablename__ = 'payouts'
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    amount = db.Column(db.Float, nullable=False)
    status = db.Column(db.String(20), default='REQUESTED') 
    wallet_address = db.Column(db.String(255), nullable=False)
    date_requested = db.Column(db.DateTime, default=func.now())
    date_paid = db.Column(db.DateTime)

# NEW MODEL 1: ማስታወቂያዎች (Ads)
class Ad(db.Model):
    __tablename__ = 'ads'
    id = db.Column(db.Integer, primary_key=True)
    title = db.Column(db.String(100), nullable=False)
    embed_url = db.Column(db.String(255), nullable=False)
    reward_amount = db.Column(db.Float, nullable=False) 
    required_view_time = db.Column(db.Integer, default=60)
    is_active = db.Column(db.Boolean, default=True)
    
    views = db.relationship('AdView', backref='ad_item', lazy='dynamic')

# NEW MODEL 2: ማስታወቂያ የታየበት መዝገብ (Ad Views)
class AdView(db.Model):
    __tablename__ = 'ad_views'
    id = db.Column(db.Integer, primary_key=True)
    ad_id = db.Column(db.Integer, db.ForeignKey('ads.id'), nullable=False)
    user_id = db.Column(db.Integer, db.ForeignKey('users.id'), nullable=False)
    status = db.Column(db.String(20), default='PENDING') # PENDING, REWARDED
    date_viewed = db.Column(db.DateTime, default=func.now())


# --- 2. DATABASE INIT & HELPER FUNCTIONS ---

def init_db():
    with app.app_context():
        db.create_all() 
        
        if not User.query.filter_by(username='Admin').first():
            admin_user = User(username='Admin', password_hash=generate_password_hash('password123'), is_admin=True)
            db.session.add(admin_user)
            db.session.commit()
            print("---!!! ማስጠንቀቂያ: ነባሪ የአድሚን አካውንት ተፈጥሯል (Admin/password123)። !!!---")

init_db()


def is_logged_in():
    return 'user_id' in session

def check_admin_access():
    if not is_logged_in(): return False
    with app.app_context():
        user = User.query.filter_by(id=session['user_id']).with_entities(User.is_admin).first()
        return user and user.is_admin

@app.context_processor
def inject_global_vars():
    return dict(is_admin=check_admin_access, min_payout=MIN_PAYOUT)


# --- 3. WORKER ROUTES (የሰራተኛ መንገዶች) ---

@app.route('/')
def index():
    if is_logged_in():
        return redirect(url_for('dashboard'))
    return render_template('index.html')

@app.route('/signup', methods=('GET', 'POST'))
def signup():
    if request.method == 'POST':
        username = request.form['username']
        password = request.form['password']
        if not username or not password:
            flash('እባክዎ ሁሉንም መስኮች ይሙሉ!', 'error')
        elif len(password) < 6:
            flash('የይለፍ ቃል ቢያንስ 6 ፊደላት መሆን አለበት።', 'error')
        else:
            try:
                with app.app_context():
                    password_hash = generate_password_hash(password)
                    new_user = User(username=username, password_hash=password_hash)
                    db.session.add(new_user)
                    db.session.commit()
                flash('በተሳካ ሁኔታ ተመዝግበዋል! አሁን መግባት ይችላሉ።', 'success')
                return redirect(url_for('login'))
            except Exception:
                flash(f'የተጠቃሚ ስም "{username}" ቀድሞውኑ አለ። ሌላ ይሞክሩ።', 'error')
    return render_template('signup.html')

@app.route('/login', methods=('GET', 'POST'))
def login():
    if request.method == 'POST':
        username = request.form['username']
        password = request.form['password']
        with app.app_context():
            user = User.query.filter_by(username=username).first()
        if user and check_password_hash(user.password_hash, password):
            session['user_id'] = user.id
            session['username'] = user.username
            flash('በተሳካ ሁኔታ ገብተዋል!', 'success')
            return redirect(url_for('dashboard'))
        else:
            flash('ትክክለኛ ያልሆነ የተጠቃሚ ስም ወይም የይለፍ ቃል!', 'error')
    return render_template('login.html')

@app.route('/logout')
def logout():
    session.pop('user_id', None)
    session.pop('username', None)
    flash('ከመለያዎ ወጥተዋል!', 'info')
    return redirect(url_for('index'))

@app.route('/dashboard')
def dashboard():
    if not is_logged_in():
        return redirect(url_for('login'))
        
    user_id = session['user_id']
    with app.app_context():
        user = User.query.filter_by(id=user_id).first()
        
        current_task = db.session.execute(db.select(Task, Inventory.gmail_username, Inventory.gmail_password)
            .join(Inventory, Task.inventory_id == Inventory.id)
            .filter(Task.user_id == user_id, Task.status.in_(['PENDING', 'SUBMITTED']))
        ).first()

        available_task = Inventory.query.filter_by(status='AVAILABLE').first()

        my_tasks = db.session.execute(db.select(Task, Inventory.gmail_username)
            .join(Inventory, Task.inventory_id == Inventory.id)
            .filter(Task.user_id == user_id)
            .order_by(Task.date_assigned.desc())
        ).scalars().all()
    
    return render_template('dashboard.html', 
                           user=user, 
                           my_tasks=my_tasks,
                           available_task=available_task,
                           current_task=current_task)

@app.route('/take_task', methods=['POST'])
def take_task():
    if not is_logged_in(): return redirect(url_for('login'))
    user_id = session['user_id']
    
    with app.app_context():
        try:
            has_active_task = Task.query.filter(Task.user_id == user_id, Task.status.in_(['PENDING', 'SUBMITTED'])).first()
            if has_active_task:
                flash('ሌላ ስራ ከመውሰድዎ በፊት አሁን የያዙትን ስራ ማጠናቀቅ አለብዎት!', 'error')
                return redirect(url_for('dashboard'))

            available_task = Inventory.query.filter_by(status='AVAILABLE').first()
            
            if available_task:
                available_task.status = 'ASSIGNED'
                new_task = Task(inventory_id=available_task.id, user_id=user_id, status='PENDING')
                db.session.add(new_task)
                db.session.commit()
                flash(f'አዲስ ሥራ ተሰጥቷችኋል! የጂሜል ስም: {available_task.gmail_username}', 'success')
            else:
                flash('ይቅርታ! ሥራው ቀድሞ ተወስዷል ወይም አዲስ ሥራ የለም።', 'info')
                
        except Exception as e:
            db.session.rollback()
            flash(f'ሥራውን በመውሰድ ላይ ስህተት ተከስቷል: {e}', 'error')
            
    return redirect(url_for('dashboard'))

@app.route('/submit_task/<int:task_id>', methods=['POST'])
def submit_task(task_id):
    if not is_logged_in(): return redirect(url_for('login'))
    user_id = session['user_id']
    completion_code = request.form.get('completion_code')
    
    if not completion_code:
        flash('የማረጋገጫ ኮዱን ማስገባት አለብዎት።', 'error')
        return redirect(url_for('dashboard'))

    with app.app_context():
        task = Task.query.filter_by(id=task_id).first()
        
        if not task or task.user_id != user_id:
            flash('ይህ ሥራ የእርስዎ አይደለም ወይም አልተገኘም።', 'error')
            return redirect(url_for('dashboard'))

        if task.status in ('SUBMITTED', 'VERIFIED'):
            flash('ይህ ሥራ አስቀድሞ ገብቷል ወይም ተረጋግጧል።', 'info')
            return redirect(url_for('dashboard'))

        try:
            task.completion_code = completion_code
            task.status = 'SUBMITTED'
            task.date_completed = func.now()
            db.session.commit()
            flash('ሥራዎ በተሳካ ሁኔታ ገብቷል። የአስተዳዳሪ ማረጋገጫን ይጠብቁ!', 'success')
            
        except Exception as e:
            db.session.rollback()
            flash(f'ሥራውን በማስረከብ ላይ ስህተት ተከስቷል: {e}', 'error')
            
    return redirect(url_for('dashboard'))

# 3.8. ክፍያ መጠየቅ (Payout Request)
@app.route('/payout_request', methods=['GET', 'POST'])
def payout_request():
    if not is_logged_in():
        return redirect(url_for('login'))
    
    user_id = session['user_id']
    with app.app_context():
        user = User.query.filter_by(id=user_id).first()
    
        if request.method == 'POST':
            try:
                amount = float(request.form['amount'])
                wallet_address = request.form['wallet_address']
                
                if amount < MIN_PAYOUT:
                    flash(f'ዝቅተኛው የክፍያ መጠን ${MIN_PAYOUT:.2f} ነው።', 'error')
                elif amount > user.pending_payout:
                    flash('ሊወጣ ከሚችለው ቀሪ ሂሳብ በላይ ጠይቀዋል።', 'error')
                elif not wallet_address:
                    flash('የUSDT Wallet አድራሻ ማስገባት አለብዎት።', 'error')
                else:
                    new_payout = Payout(user_id=user_id, amount=amount, wallet_address=wallet_address)
                    db.session.add(new_payout)
                    
                    user.pending_payout -= amount
                                         
                    db.session.commit()
                    flash(f'የ ${amount:.2f} ክፍያ ጥያቄ ገብቷል። አስተዳዳሪ እስኪያረጋግጥ ይጠብቁ።', 'success')
                    return redirect(url_for('dashboard'))

            except ValueError:
                flash('ትክክለኛ መጠን ያስገቡ።', 'error')
            except Exception as e:
                db.session.rollback()
                flash(f'ጥያቄውን በማስገባት ላይ ስህተት ተከስቷል: {e}', 'error')
                
    return render_template('payout_request.html', user=user)

# 3.9. የይለፍ ቃል መቀየር (NEW)
@app.route('/change_password', methods=['GET', 'POST'])
def change_password():
    if not is_logged_in():
        return redirect(url_for('login'))
    
    user_id = session['user_id']
    
    if request.method == 'POST':
        current_password = request.form['current_password']
        new_password = request.form['new_password']
        confirm_password = request.form['confirm_password']
        
        with app.app_context():
            user = User.query.filter_by(id=user_id).first()
            
            if not user:
                flash('የተጠቃሚ መለያ አልተገኘም።', 'error')
                return redirect(url_for('dashboard'))

            if not check_password_hash(user.password_hash, current_password):
                flash('ያስገቡት የአሁኑ የይለፍ ቃል ትክክል አይደለም።', 'error')
            
            elif new_password != confirm_password:
                flash('አዲሱ የይለፍ ቃል እና የማረጋገጫው ቃል አይመሳሰሉም።', 'error')
            elif len(new_password) < 6:
                flash('አዲሱ የይለፍ ቃል ቢያንስ 6 ፊደላት መሆን አለበት።', 'error')
            
            else:
                try:
                    user.password_hash = generate_password_hash(new_password)
                    db.session.commit()
                    flash('የይለፍ ቃልዎ በተሳካ ሁኔታ ተቀይሯል።', 'success')
                    return redirect(url_for('dashboard'))
                
                except Exception as e:
                    db.session.rollback()
                    flash(f'የይለፍ ቃል በመቀየር ላይ ስህተት ተከስቷል: {e}', 'error')
                    
    return render_template('change_password.html')

# 3.10. ማስታወቂያ ማየት እና ገንዘብ ማግኘት (NEW)
@app.route('/view_ads')
def view_ads():
    if not is_logged_in():
        return redirect(url_for('login'))
    
    user_id = session['user_id']
    with app.app_context():
        available_ads = Ad.query.filter_by(is_active=True).all()
        
        today = func.date(func.now())
        viewed_today = db.session.execute(db.select(AdView.ad_id)
            .filter(AdView.user_id == user_id, AdView.status == 'REWARDED', func.date(AdView.date_viewed) == today)
        ).scalars().all()
        
    return render_template('view_ads.html', available_ads=available_ads, viewed_today=viewed_today)

# 3.11. ማስታወቂያውን ከተመለከቱ በኋላ ክፍያውን መመዝገብ (NEW)
@app.route('/register_ad_reward/<int:ad_id>', methods=['POST'])
def register_ad_reward(ad_id):
    if not is_logged_in():
        return jsonify({'success': False, 'message': 'Not logged in'}), 401
    
    user_id = session['user_id']
    
    with app.app_context():
        ad = Ad.query.filter_by(id=ad_id, is_active=True).first()
        user = User.query.filter_by(id=user_id).first()
        
        if not ad or not user:
            return jsonify({'success': False, 'message': 'Ad or User not found'}), 404

        today = func.date(func.now())
        already_rewarded = AdView.query.filter(
            AdView.ad_id == ad_id,
            AdView.user_id == user_id,
            AdView.status == 'REWARDED',
            func.date(AdView.date_viewed) == today
        ).first()

        if already_rewarded:
            return jsonify({'success': False, 'message': 'You have already been rewarded for this ad today.'}), 400
            
        try:
            # 1. ክፍያውን መጨመር
            user.pending_payout += ad.reward_amount
            user.total_earned += ad.reward_amount
            
            # 2. ክፍያውን መመዝገብ
            new_view = AdView(ad_id=ad_id, user_id=user_id, status='REWARDED')
            db.session.add(new_view)
            db.session.commit()
            
            return jsonify({
                'success': True, 
                'message': f'${ad.reward_amount:.2f} successfully added to your balance!',
                'new_balance': f'{user.pending_payout:.2f}'
            }), 200
            
        except Exception as e:
            db.session.rollback()
            return jsonify({'success': False, 'message': 'Internal Server Error'}), 500


# --- 4. ADMIN ROUTES (አስተዳዳሪ መንገዶች) ---

@app.route('/admin/dashboard')
def admin_dashboard():
    if not check_admin_access():
        flash('የአስተዳዳሪ መብት የለዎትም።', 'error')
        return redirect(url_for('dashboard'))
    
    with app.app_context():
        pending_tasks_count = Task.query.filter_by(status='SUBMITTED').count()
        total_inventory_count = Inventory.query.filter_by(status='AVAILABLE').count()
        total_users_count = User.query.filter_by(is_admin=False).count()

    return render_template('admin_dashboard.html', 
                           pending_tasks_count=pending_tasks_count,
                           total_inventory_count=total_inventory_count,
                           total_users_count=total_users_count)


@app.route('/admin/add_tasks', methods=['GET', 'POST'])
def admin_add_tasks():
    if not check_admin_access():
        return redirect(url_for('dashboard'))
    
    if request.method == 'POST':
        task_data = request.form.get('task_data')
        
        if not task_data:
            flash('እባክዎ የጂሜል መረጃውን ያስገቡ።', 'error')
            return render_template('admin_add_tasks.html')
            
        lines = task_data.strip().split('\n')
        successful_inserts = 0
        failed_tasks = []

        with app.app_context():
            for line in lines:
                line = line.strip()
                if not line: continue
                
                if ':' in line:
                    parts = line.split(':', 1)
                    username = parts[0].strip()
                    password = parts[1].strip()
                    if username and password:
                        try:
                            new_inventory = Inventory(gmail_username=username, gmail_password=password)
                            db.session.add(new_inventory)
                            db.session.commit()
                            successful_inserts += 1
                        except Exception:
                            db.session.rollback()
                            failed_tasks.append(f"Duplicate/Error: {username}")
                    else:
                        failed_tasks.append(f"Invalid format: {line}")
                else:
                    failed_tasks.append(f"Missing separator: {line}")
        
            if successful_inserts > 0:
                flash(f'በተሳካ ሁኔታ {successful_inserts} አዲስ ስራዎች ወደ ክምችት ገብተዋል።', 'success')
            if failed_tasks:
                flash(f'በመግቢያ ላይ ስህተት የተፈጠረባቸው ስራዎች ({len(failed_tasks)}): ' + '; '.join(failed_tasks[:5]) + '...', 'warning')

        return redirect(url_for('admin_dashboard'))

    return render_template('admin_add_tasks.html')


# 4.3. ማስታወቂያዎችን መፍጠር እና ማስተዳደር (NEW)
@app.route('/admin/manage_ads', methods=['GET', 'POST'])
def admin_manage_ads():
    if not check_admin_access():
        return redirect(url_for('dashboard'))
    
    with app.app_context():
        if request.method == 'POST':
            title = request.form.get('title')
            embed_url = request.form.get('embed_url')
            
            try:
                reward_amount = float(request.form.get('reward_amount'))
                view_time = int(request.form.get('view_time'))
            except (ValueError, TypeError):
                flash('ክፍያ እና ሰዓት በቁጥር መግባት አለባቸው!', 'error')
                return redirect(url_for('admin_manage_ads'))
            
            try:
                if 'watch?v=' in embed_url:
                    embed_url = embed_url.replace('watch?v=', 'embed/')

                new_ad = Ad(
                    title=title, 
                    embed_url=embed_url, 
                    reward_amount=reward_amount, 
                    required_view_time=view_time
                )
                db.session.add(new_ad)
                db.session.commit()
                flash(f'ማስታወቂያው "{title}" በተሳካ ሁኔታ ተጨምሯል።', 'success')
                return redirect(url_for('admin_manage_ads'))
            except Exception as e:
                db.session.rollback()
                flash(f'ማስታወቂያ በማስገባት ላይ ስህተት ተከስቷል: {e}', 'error')

        ads = Ad.query.all()
    
    return render_template('admin_manage_ads.html', ads=ads)

# 4.4. የማስታወቂያ ሁኔታ መቀየር (አክቲቭ/ኢናክቲቭ) (NEW)
@app.route('/admin/toggle_ad/<int:ad_id>', methods=['POST'])
def admin_toggle_ad(ad_id):
    if not check_admin_access():
        return redirect(url_for('dashboard'))
    
    with app.app_context():
        ad = Ad.query.filter_by(id=ad_id).first()
        if ad:
            ad.is_active = not ad.is_active
            db.session.commit()
            flash(f'የማስታወቂያው ሁኔታ ወደ {"Active" if ad.is_active else "Inactive"} ተቀይሯል።', 'info')
        else:
            flash('ማስታወቂያ አልተገኘም።', 'error')
    
    return redirect(url_for('admin_manage_ads'))

# 4.5. ሥራዎችን ማረጋገጥ 
@app.route('/admin/verify_tasks')
def admin_verify_tasks():
    if not check_admin_access():
        return redirect(url_for('dashboard'))

    with app.app_context():
        submitted_tasks = db.session.execute(db.select(Task.id.label('task_id'), Task.completion_code, Task.date_completed, Inventory.gmail_username, User.username.label('worker_username'))
            .join(Inventory, Task.inventory_id == Inventory.id)
            .join(User, Task.user_id == User.id)
            .filter(Task.status == 'SUBMITTED')
            .order_by(Task.date_completed.asc())
        ).all()
        
    return render_template('admin_verify_tasks.html', submitted_tasks=submitted_tasks)

# 4.6. የሥራ ማረጋገጫ እርምጃ
@app.route('/admin/action_task/<int:task_id>/<action>', methods=['POST'])
def admin_action_task(task_id, action):
    if not check_admin_access():
        return redirect(url_for('dashboard'))
    
    with app.app_context():
        task = Task.query.filter_by(id=task_id).first()

        if not task or task.status != 'SUBMITTED':
            flash('ይህ ሥራ አልተገኘም ወይም ለመረጋገጥ ዝግጁ አይደለም።', 'error')
            return redirect(url_for('admin_verify_tasks'))

        try:
            inventory_item = Inventory.query.filter_by(id=task.inventory_id).first()
            user = User.query.filter_by(id=task.user_id).first()
            
            if action == 'verify':
                task.status = 'VERIFIED'
                if inventory_item:
                    inventory_item.status = 'COMPLETED'
                
                if user:
                    user.pending_payout += PAYOUT_AMOUNT_PER_TASK
                    user.total_earned += PAYOUT_AMOUNT_PER_TASK
                
                db.session.commit()
                flash(f'ሥራው በተሳካ ሁኔታ ተረጋግጧል። ${PAYOUT_AMOUNT_PER_TASK:.2f} ለሰራተኛው ተጨምሯል።', 'success')

            elif action == 'reject':
                task.status = 'REJECTED'
                if inventory_item:
                    inventory_item.status = 'AVAILABLE' 
                
                db.session.commit()
                flash('ሥራው አልተቀበልም። ወደ ሥራ ክምችት ተመልሷል።', 'info')
                
            else:
                flash('ትክክለኛ ያልሆነ እርምጃ።', 'error')

        except Exception as e:
            db.session.rollback()
            flash(f'ማረጋገጫው ላይ ስህተት ተከስቷል: {e}', 'error')

    return redirect(url_for('admin_verify_tasks'))


# 4.7. የክፍያ አስተዳደር
@app.route('/admin/payouts')
def admin_payouts():
    if not check_admin_access():
        return redirect(url_for('dashboard'))

    with app.app_context():
        payout_requests = db.session.execute(db.select(Payout.id.label('payout_id'), Payout.amount, Payout.wallet_address, Payout.date_requested, User.username.label('worker_username'))
            .join(User, Payout.user_id == User.id)
            .filter(Payout.status == 'REQUESTED')
            .order_by(Payout.date_requested.asc())
        ).all()
    
    return render_template('admin_payouts.html', payout_requests=payout_requests)


# 4.8. የክፍያ እርምጃ
@app.route('/admin/action_payout/<int:payout_id>/<action>', methods=['POST'])
def admin_action_payout(payout_id, action):
    if not check_admin_access():
        return redirect(url_for('dashboard'))
    
    with app.app_context():
        payout = Payout.query.filter_by(id=payout_id).first()

        if not payout or payout.status != 'REQUESTED':
            flash('ጥያቄው አልተገኘም ወይም አስቀድሞ ተስተናግዷል።', 'error')
            return redirect(url_for('admin_payouts'))
        
        user = User.query.filter_by(id=payout.user_id).first()

        try:
            if action == 'paid':
                payout.status = 'PAID'
                payout.date_paid = func.now()
                db.session.commit()
                flash(f'የ ${payout.amount:.2f} ክፍያ እንደተፈጸመ ምልክት ተደርጓል።', 'success')

            elif action == 'reject':
                payout.status = 'REJECTED'
                
                if user:
                    user.pending_payout += payout.amount
                
                db.session.commit()
                flash(f'የ ${payout.amount:.2f} ክፍያ ጥያቄ ውድቅ ተደርጓል፣ ገንዘቡ ወደ ቀሪ ሂሳብ ተመልሷል።', 'info')
                
            else:
                flash('ትክክለኛ ያልሆነ እርምጃ።', 'error')

        except Exception as e:
            db.session.rollback()
            flash(f'የክፍያ እርምጃ ላይ ስህተት ተከስቷል: {e}', 'error')

    return redirect(url_for('admin_payouts'))


# --- 5. RUN APP ---
if __name__ == '__main__':
    with app.app_context():
        app.run(debug=True, host='0.0.0.0', port=5000)